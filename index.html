<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dentist Timesheet Cloud</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700;800&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // *** ใส่ URL ของคุณที่นี่ ***
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxBGCAtzlEzAeUPjGpD0eejUxNj2BZ0zuOxnEz6rNjdq-W5MMPkK4aWRHieY2voUk87-g/exec";

        const EMPLOYEES = ["หมอเบ็น", "หมอเบส", "หมออ๊อด", "หมอผิง", "หมอปุ้ม", "หมอตุล", "หมอท็อป", "หมอขิง", "หมอนัชชี่", "หมอป้อม"];
        const ADMIN_PASSWORD = "88888888";
        
        const TABS_CONFIG = [
            { label: "ธ.ค. 68", month: 11, year: 2025 },
            { label: "ม.ค. 69", month: 0, year: 2026 }, { label: "ก.พ. 69", month: 1, year: 2026 },
            { label: "มี.ค. 69", month: 2, year: 2026 }, { label: "เม.ย. 69", month: 3, year: 2026 },
            { label: "พ.ค. 69", month: 4, year: 2026 }, { label: "มิ.ย. 69", month: 5, year: 2026 },
            { label: "ก.ค. 69", month: 6, year: 2026 }, { label: "ส.ค. 69", month: 7, year: 2026 },
            { label: "ก.ย. 69", month: 8, year: 2026 }, { label: "ต.ค. 69", month: 9, year: 2026 },
            { label: "พ.ย. 69", month: 10, year: 2026 }, { label: "ธ.ค. 69", month: 11, year: 2026 }
        ];

        // --- ระบบ Icons แบบง่าย ---
        const IconMapPin = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>;
        const IconGlobe = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>;

        const App = () => {
            const [user, setUser] = useState(localStorage.getItem('user'));
            const [isAdmin, setIsAdmin] = useState(user === 'Admin');
            const [attendance, setAttendance] = useState({});
            const [isEditMode, setIsEditMode] = useState(false);
            const [activeTab, setActiveTab] = useState(1); // มกราคม 2569
            const [loading, setLoading] = useState(false);

            // ดึงข้อมูลจาก Google Sheets ครั้งแรก
            useEffect(() => {
                fetchData();
            }, []);

            const fetchData = async () => {
                try {
                    const res = await fetch(GOOGLE_SCRIPT_URL);
                    const data = await res.json();
                    // แปลงข้อมูลจาก Sheet กลับเป็น Object { dateKey: { empName: status } }
                    const formatted = {};
                    data.slice(1).forEach(row => {
                        const [ts, dateKey, emp, status] = row;
                        if (!formatted[dateKey]) formatted[dateKey] = {};
                        formatted[dateKey][emp] = status === "null" ? null : status;
                    });
                    setAttendance(formatted);
                } catch (e) { console.error("Load error:", e); }
            };

            const handleToggle = async (dateKey, emp) => {
                if (!isEditMode) return alert("โปรดกด Unlock ก่อนแก้ไข");
                if (!isAdmin && user !== emp) return alert("แก้ไขได้เฉพาะของตนเอง");

                const currentStatus = attendance[dateKey]?.[emp];
                let nextStatus = null;
                if (!currentStatus) nextStatus = 'onsite';
                else if (currentStatus === 'onsite') nextStatus = 'online';

                // อัปเดต UI ทันที (Optimistic Update)
                const newAttendance = { ...attendance, [dateKey]: { ...(attendance[dateKey] || {}), [emp]: nextStatus } };
                setAttendance(newAttendance);

                // ส่งไป Google Sheets
                setLoading(true);
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // จำเป็นสำหรับ Apps Script
                        body: JSON.stringify({ dateKey, employee: emp, status: String(nextStatus) })
                    });
                } catch (e) { console.error("Save error:", e); }
                setLoading(false);
            };

            if (!user) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-slate-900 p-4">
                        <div className="bg-white p-8 rounded-3xl w-full max-w-md shadow-2xl">
                            <h1 className="text-2xl font-black mb-6 text-center">เลือกรายชื่อผู้ใช้งาน</h1>
                            <div className="grid grid-cols-2 gap-3">
                                {EMPLOYEES.map(e => (
                                    <button key={e} onClick={() => { setUser(e); localStorage.setItem('user', e); }} className="p-4 bg-slate-50 hover:bg-blue-500 hover:text-white font-bold rounded-2xl transition-all">{e}</button>
                                ))}
                            </div>
                            <button onClick={() => {
                                const p = prompt("ใส่รหัส Admin");
                                if(p === ADMIN_PASSWORD) { setUser('Admin'); setIsAdmin(true); localStorage.setItem('user', 'Admin'); }
                            }} className="w-full mt-6 p-4 text-slate-400 font-bold uppercase text-xs tracking-widest">Admin Access</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-20">
                    <header className="bg-slate-900 text-white p-6 sticky top-0 z-50 flex justify-between items-center shadow-xl">
                        <div>
                            <p className="text-[10px] text-blue-400 font-black tracking-widest">LOGGED IN AS</p>
                            <h2 className="text-xl font-black uppercase">{user}</h2>
                        </div>
                        <button onClick={() => { localStorage.clear(); location.reload(); }} className="text-xs bg-rose-500/20 text-rose-400 px-4 py-2 rounded-xl border border-rose-500/30 font-bold">LOGOUT</button>
                    </header>

                    <main className="p-4 max-w-5xl mx-auto">
                        <div className="flex gap-2 overflow-x-auto no-scrollbar mb-6 p-1 bg-white rounded-2xl shadow-inner border border-slate-200">
                            {TABS_CONFIG.map((tab, i) => (
                                <button key={i} onClick={() => setActiveTab(i)} className={`px-6 py-3 rounded-xl text-[10px] font-black min-w-max transition-all ${activeTab === i ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400'}`}>{tab.label}</button>
                            ))}
                        </div>

                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-2xl font-black italic">SCHEDULE</h3>
                            <button onClick={() => setIsEditMode(!isEditMode)} className={`px-8 py-3 rounded-2xl font-black text-xs tracking-widest transition-all shadow-lg ${isEditMode ? 'bg-amber-500 text-white' : 'bg-white border-2 border-slate-200'}`}>
                                {isEditMode ? 'DONE & LOCK' : 'UNLOCK TO EDIT'}
                            </button>
                        </div>

                        <div className="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-200">
                            <div className="overflow-x-auto">
                                <table className="w-full text-center border-collapse">
                                    <thead>
                                        <tr className="bg-slate-800 text-white text-[10px] uppercase font-black tracking-widest">
                                            <th className="p-4 sticky left-0 bg-slate-800 z-10">Date</th>
                                            {EMPLOYEES.filter(e => isAdmin || e === user).map(e => (
                                                <th key={e} className="p-4 min-w-[100px] border-l border-slate-700">{e.replace('หมอ','')}</th>
                                            ))}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {[...Array(new Date(TABS_CONFIG[activeTab].year, TABS_CONFIG[activeTab].month + 1, 0).getDate())].map((_, i) => {
                                            const day = i + 1;
                                            const dateKey = `${TABS_CONFIG[activeTab].year}-${TABS_CONFIG[activeTab].month}-${day}`;
                                            return (
                                                <tr key={day} className="border-b border-slate-50 hover:bg-slate-50/50">
                                                    <td className="p-4 font-black text-slate-400 sticky left-0 bg-white border-r">{day}</td>
                                                    {EMPLOYEES.filter(e => isAdmin || e === user).map(e => {
                                                        const status = attendance[dateKey]?.[e];
                                                        return (
                                                            <td key={e} className="p-2">
                                                                <button onClick={() => handleToggle(dateKey, e)} className={`w-full h-12 rounded-xl flex items-center justify-center transition-all ${status === 'onsite' ? 'bg-blue-600 text-white shadow-lg' : status === 'online' ? 'bg-purple-600 text-white shadow-lg' : 'bg-slate-100 text-slate-200 opacity-30'}`}>
                                                                    {status === 'onsite' && <IconMapPin />}
                                                                    {status === 'online' && <IconGlobe />}
                                                                    {!status && <span className="text-[10px] font-black">+</span>}
                                                                </button>
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>

                    {loading && (
                        <div className="fixed bottom-6 right-6 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-pulse">
                            <div className="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                            <span className="text-[10px] font-black tracking-widest">SAVING TO CLOUD...</span>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
